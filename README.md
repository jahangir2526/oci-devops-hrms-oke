# Overview

This project will describe high level steps to setup a **CI/CD using OCI DevOps** to deploy a **sample HRMS App (php, nginx, ATP)** in a Kubernetes cluster (**OKE**).

## Steps

### 1. Information (to be captured/required/filled)

```
OCI Username: <oci-username>	#eg: oracleidentitycloudservice/user01_idcs
OCI Auth Token: <oci-auth-token>
Tenancy Name: <tenancy-name>
Tenancy Namespace: <tenancy-namespace>	# object storage namespace, eg: ansh81vru1zp

Docker CLI credentials:
Username: <tenancy-namespace>/<oci-username> #eg: ansh81vru1zp/oracleidentitycloudservice/user01
Password: <oci-auth-token>

OCI Code Repo CLI credentials:
Username: <tenancy-name>/<oci-username> 
Password: <oci-auth-token>

ADB Database:
Username: 
Password:
Region:
Compartment:

Kubernetes Resources:
K8s Namespace: <k8s-namespace>	## this will be created to deploy k8s resources for hrms application
OCIR Registry Secret: <docker-registry-secret> ## name of kubernetes docker registry secret to pull image from OCIR
ADB K8s Secret: <adb-secret>		# kubernetes secret name will be created for ADB credentials

## Following information will be required later while setting up DevOps CI/CD pipeline
### Build Pipeline Parameters:
P_OCIR_REGION_KEY
P_TENANCY_NAMESPACE
P_OCIR_REPO_NAME_NGINX
P_OCIR_REPO_NAME_PHP_ADB
P_OCI_USERNAME

## Deployment Pipeline Parameters
P_OCIR_REGION_KEY
P_TENANCY_NAMESPACE
P_OCIR_REPO_NAME
P_K8S_NAMESPACE
P_ADB_SECRET_NAME						#  kubernetes secret name created for ADB's USER, PASSWORD, TNSNAMES
P_IMAGE_PULL_SECRET					#  kubernetes docker registry secret to pull image from OCIR
BUILDRUN_HASH ## provide if start manual deployment. not required if trigger deployment from build_pipeline

```

### 2. Spin up Kubernetes cluster | Create registry secret | Create Other Resources

```
i. Spin up a Kubernetes cluster (OKE)
ii. Login into OKE using cloud shell
iii. Create kubernetes namespace ()
     $ kubectl create ns <name-namespace>  
iv. Create a registry secret
$ kubectl create secret docker-registry <secret-name> --docker-server=<region-key>.ocir.io --docker-username='<tenancy-namespace>/<oci-username>' --docker-password='<oci-auth-token>' --docker-email='<email-address>'

iv. (If required) Create any other resource (eg: namespace, secret, pv etc) to fullfill app requirements

```

### 3. Create OCIR Repository

```
## Create two OCIR Repositories using OCI console and note the following information
OCIR Region: <ocir-region> # eg: Singapore
OCIR Repo Region Key: <region-key>	# eg: iad
OCIR Repo Compartment Name: <ocir-repo-comp-name>	# :ASEAN/Jahangir/Demo

## For nginx
OCIR Repo Name: # <ocir-repo-name> # eg: hrms/nginx1

## For php-adb
OCIR Repo Name: # <ocir-repo-name> # eg: hrms/php-adb1

```

### 2. HRMS App Resources and PHP-ATP integration

#### a. Provision an ATP instance | Download Instance Wallet

```
i. Note the following info
Name: <atp-name>
Compartment: <atp-compartment>
Region: <atp-region>

ii. Download instance wallet (eg: Wallet_HRMS.zip)

iii. Create new table in Autonomous Database using Oracle Database Action or any database client of your choice.

CREATE TABLE employee_data (
 id NUMBER GENERATED BY DEFAULT AS IDENTITY,
 first_name VARCHAR2(50) NOT NULL,
 last_name VARCHAR2(50) NOT NULL,
 gender VARCHAR2(50) NOT NULL,
 email VARCHAR2(50) NOT NULL,
 hire_date VARCHAR2(50) NOT NULL,
 department VARCHAR2(50) NOT NULL,
 job VARCHAR2(50) NOT NULL,
 salary NUMBER(10,2) NOT NULL,
 PRIMARY KEY(id)
);
```

#### b. PHP-ATP integration

```
i. Copy the wallet file in php-adb folder
ii. Change line 13 and 14 of the Dockerfile in php-adb folder to the name of your wallet file
    
    ADD <wallet file name> /opt/oracle/<wallet file name> 
    RUN cd /opt/oracle && unzip /opt/oracle/<wallet file name>
    
iii. ## Create a kubernetes secret resource for Autonamous Database credentials.

$ cat > secret-adb.yml
apiVersion: v1
kind: Secret
metadata:
  name: adb-secret
type: Opaque
stringData:
  ADB_USER: <adb-username>	# eg: ADMIN
  ADB_PASSWORD: <adb-password>
  ADB_TNSNAME: <adb-tnsname>	# eg: hrms_medium
  TNS_ADMIN: /opt/oracle/
  
$ kubectl apply -f adb-secret.yaml -n hrms-webapp-adb
```

### 4. Create Vault, Master Encryption Key, Secret

```
Vault Secret OCID (oci-auth-token): <vault-secret-ocid>
```

### 5. Setup OCI DevOps (CI/CD)
#### a) Create DevOps Project
```
i. Create a notification topic
ii. Create DevOps project
iii. Enable logging
```
#### b) Create/Mirror Repository
```
## Create new repo
i. Create & Clone the empty repo to client machine
ii. Copy application codes
iii. Push to OCI Code Repo

OR

## Mirror Repo
i. Get the github PAT (personal access token)
ii. Create a secret using PAT
iii. Create External Connection (github/gitlab)
ii. Mirror Repository, select connection, provide mirror schedule (once/default-30mins/custom)
```
#### c) Get & Edit the build_spec.yml file, make sure the changes are in the repository.

```
## If needed edit build_spec.yml especially add value for OCIRCRED # ocid of vault secret

## Variable/Parameter used in build_spec.yml
P_OCIR_REGION_KEY
P_TENANCY_NAMESPACE
P_OCIR_REPO_NAME_NGINX
P_OCIR_REPO_NAME_PHP_ADB
P_OCI_USERNAME
P_NAMESPACE_KUBERNETES
```

#### d) Create Build Pipeline

```
i. create build pipeline
ii. create stage->Manage Build-> [Select Primary Code Repository]
iii. add value for parameters ref-5c to build pipeline Parameter section
iii. start a manual run to test # by selecting the latest commit hash
iv. check if build was successfull by checking the docker image
```

#### e) Create DevOps environment selecting OKE Cluster(s)

#### f) Edit the deploy.yaml file & create devops artifact

```
## edit k8s_deployment.yaml file as required

## Variable/Parameter used in build_spec.yml
P_OCIR_REGION_KEY
P_TENANCY_NAMESPACE
P_OCIR_REPO_NAME
P_NAMESPACE_KUBERNETES
P_IMAGE_PULL_SECRET
BUILDRUN_HASH ## provide if start manual deployment. not required if trigger deployment from build_pipeline

```

#### g) Create Deployment Pipeline

```
i. create deployment pipeline
ii. add stage-> (select Apply manifest to K8s cluster)
iii. select artifacts
ii. add values for parameters ref-5f to deploy pipeline Parameter section
iii. start a manual run and check 
```

#### h) Create Trigger to automate CI/CD

```
Steps here
```



## Reference



## Author

